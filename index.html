<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Hist441-project by dangerful</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <link rel="stylesheet" href="stylesheets/countries.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <script src="javascripts/svg-pan-zoom.min.js"></script>
    <script src="javascripts/chroma.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">
      <section>
        <div id="JewPopulations">
          <h1>Jewish Populations</h1>
          <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#PreNazi">Pre-Nazi Rule</a></li>
            <li><a data-toggle="tab" href="#Year1942">1942</a></li>
            <li><a data-toggle="tab" href="#PostWar">Post-War</a></li>
          </ul>
          <div class="tab-content">
            <div id="PreNazi" class="tab-pane fade in active">
            </div>
            <div id="Year1942" class="tab-pane fade">
            </div>
            <div id="PostWar" class="tab-pane fade">
            </div>
          </div>
        </div>
        <div id="ImmigrationEmigration">
          <h1>Immigration and Emigration (1935 - 1941)</h1>
          <div id="Refugees" class="tab-pane fade in active">
          </div>
        </div>
        <div id="Deaths">
          <h1>Deaths By Country</h1>
          <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#JewDeaths">Jew Deaths</a></li>
            <li><a data-toggle="tab" href="#RomaDeaths">Roma Deaths</a></li>
          </ul>
          <div class="tab-content">
            <div id="JewDeaths" class="tab-pane fade in active">
            </div>
            <div id="RomaDeaths" class="tab-pane fade">
            </div>
          </div>
        </div>
        <script type="text/javascript">
          var negativeScale = chroma.scale([0xffc58a, 0x8b0000]).colors(101);
          var positiveScale = chroma.scale([0x9dc680, 0x008000]).colors(101);
          var populationSvgs = []; 
          var deathSvgs = []; 
          var width = 960,
            height = 920;
          var countries;
          d3.json("cntry1938.json", function(error, world) {
            if (error) return console.error(error);
            console.log(world);
            countries = topojson.feature(world, world.objects.cntry1938);

            RenderJewishPopulations("PreNazi");
            RenderRefugees();
            RenderDeaths("Jew");

            RenderJewishPopulations("Year1942");
            RenderJewishPopulations("PostWar");
            RenderDeaths("Roma");
          });

          function RenderJewishPopulations(type){
            d3.json(type+"JewPopulation.json", function(error, populations) {
              if (error) return console.error(error);

              var id = type + "PopulationMap";
              var section = d3.select("#" + type);
              var svg = section.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("id", id);
              var projection = d3.geo.mercator();
              var path = d3.geo.path().projection(projection);
              svg.append("path")
                .datum(countries)
                .attr("d", path);

              var tooltip = d3.select('#JewPopulations').append('div')
              .attr('class', 'hidden tooltip');

              svg.selectAll(".countries").data(countries.features).enter().append("path")
                .attr("class", function(d) { return "country " + d.properties.NAME.replace(" ", "");})
                .attr("d", path)
                .on('mousemove', function(d) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });
                    var clientRectangle = jQuery("#" + type).position();
                    var overlay = tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15 + clientRectangle.left) +
                                'px; top:' + (mouse[1] + 15 + clientRectangle.top) + 'px');
                    var found = false;
                    for (var i = 0; i < populations.length; i++){
                      if (populations[i].country === d.properties.NAME){
                        overlay.html("<b>" + d.properties.NAME + "</b><br/>Population: ~" + populations[i].jewPopulation);
                        found = true;
                        break;
                      }                    
                    } 
                    if (found === false) {
                      overlay.html("<b>" + d.properties.NAME + "</b>");
                    }  
                        
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                })
                .attr("background", "#1C6BA0");

              for (var i = 0; i < populations.length; i++) {
                var color;
                if (populations[i].jewPopulation == null) {
                  color = 'grey';
                } else {
                  color = negativeScale[Math.round((populations[i].jewPopulation/3100000)*100)];
                }
                svg.selectAll("." + populations[i].country.replace(" ", "")).attr("style", "fill:" + color);
              }

              var svgNode = svg.node();
              var lastEventListener = function(){
                var panZoomMap = svgPanZoom(svgNode, {
                  zoomEnabled: true,
                  controlIconsEnabled: true,
                  fit: false
                });
                panZoomMap.setOnZoom(function(level){
                  zoom(level, populationSvgs);
                });

                panZoomMap.setOnPan(function(point){
                  pan(point, populationSvgs)
                })

                populationSvgs.push(panZoomMap);


                zoom(3, populationSvgs);
                pan({x:-1300, y: 300}, populationSvgs);
              };
              //svgNode.addEventListener('load', lastEventListener);
              lastEventListener();
            });
          }

          function RenderRefugees(){
            d3.json("Refugees.json", function(error, refugees) {
              if (error) return console.error(error);

              var id = "RefugeesMap";
              var section = d3.select("#Refugees");
              var svg = section.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("id", id);
              var projection = d3.geo.mercator();
              var path = d3.geo.path().projection(projection);
              svg.append("path")
                .datum(countries)
                .attr("d", path);

              var tooltip = d3.select('#Refugees').append('div')
              .attr('class', 'hidden tooltip');

              svg.selectAll(".countries").data(countries.features).enter().append("path")
                .attr("class", function(d) { return "country " + d.properties.NAME.replace(" ", "");})
                .attr("d", path)
                .on('mousemove', function(d) {
                  var mouse = d3.mouse(svg.node()).map(function(d) {
                      return parseInt(d);
                  });

                  var clientRectangle = jQuery("#Refugees").position();
                  var overlay = tooltip.classed('hidden', false)
                      .attr('style', 'left:' + (mouse[0] + 15 + clientRectangle.left) +
                              'px; top:' + (mouse[1] + 15 + clientRectangle.top) + 'px');
                  var found = false;
                  for (var j = 0; j < refugees.emigration.length; j++){
                    if (refugees.emigration[j].country === d.properties.NAME){
                      overlay.html("<b>" + d.properties.NAME + "</b><br/>Emigrated: ~" + refugees.emigration[j].number);
                      found = true;
                      break;
                    }                      
                  }
                  for (var j = 0; j < refugees.immigration.length; j++){
                    if (refugees.immigration[j].country === d.properties.NAME){
                      overlay.html("<b>" + d.properties.NAME + "</b><br/>Immigrated: ~" + refugees.immigration[j].number);     
                      found = true;
                      break;
                    }                
                  }
                  if (found === false) {
                    overlay.html("<b>" + d.properties.NAME + "</b>");
                  }
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
              })
              .attr("background", "#1C6BA0");

              for (var j = 0; j < refugees.emigration.length; j++){
                var color;
                if (refugees.emigration[j].number == null) {
                  color = 'grey';
                } else {
                  color = negativeScale[Math.round((refugees.emigration[j].number/300000)*100)];
                }
                svg.selectAll("." + refugees.emigration[j].country.replace(" ", "")).attr("style", "fill:" + color);
              }
              for (var j = 0; j < refugees.immigration.length; j++){
                var color;
                if (refugees.immigration[j].number == null) {
                  color = 'grey';
                } else {
                  color = positiveScale[Math.round((refugees.immigration[j].number/300000)*100)];
                }
                svg.selectAll("." + refugees.immigration[j].country.replace(" ", "")).attr("style", "fill:" + color);
              }

              var svgNode = svg.node();
              var lastEventListener = function(){
                var panZoomMap = svgPanZoom(svgNode, {
                  zoomEnabled: true,
                  controlIconsEnabled: true,
                  fit: false
                });
              };
              //svgNode.addEventListener('load', lastEventListener);
              lastEventListener();
            });
          }

          function RenderDeaths(type){
            d3.json(type+"Deaths.json", function(error, deaths) {
              if (error) return console.error(error);


              <!--https://bost.ocks.org/mike/map/ -->
              var id = type + "DeathMap";
              var section = d3.select("#" + type + "Deaths"); 
              var width = 960,
                height = 920;

              var svg = section.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("id", id);

              var projection = d3.geo.mercator();
              var path = d3.geo.path().projection(projection);
              svg.append("path")
                .datum(countries)
                .attr("d", path);

              var tooltip = d3.select('#Deaths').append('div')
              .attr('class', 'hidden tooltip');

              svg.selectAll(".countries").data(countries.features).enter().append("path")
                .attr("class", function(d) { return "country " + d.properties.NAME.replace(" ", "");})
                .attr("d", path)
                .on('mousemove', function(d) {
                    var mouse = d3.mouse(section.node()).map(function(d) {
                        return parseInt(d);
                    });
                    var clientRectangle = jQuery("#" + type + "Deaths").position();
                    var overlay = tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15 + clientRectangle.left) +
                                'px; top:' + (mouse[1] + 15 + clientRectangle.top) + 'px');
                    var found = false;
                    for (var i = 0; i < deaths.length; i++){
                      if (deaths[i].country === d.properties.NAME){
                        if (deaths[i].minLoss === deaths[i].maxLoss || deaths[i].maxLoss == null){
                          overlay.html("<b>" + d.properties.NAME + "</b><br/>" + type + " Deaths: ~" + deaths[i].minLoss);// + "<br/>% of Population: " + deaths[i].percent);
                        } else {
                          overlay.html("<b>" + d.properties.NAME + "</b><br/>" + type + " Deaths: " + deaths[i].minLoss + " - " + deaths[i].maxLoss);// + "<br/>% of Population: " + deaths[i].percent);
                        }
                        found = true;
                        break;
                      }                    
                    } 
                    if (found === false) {
                      overlay.html("<b>" + d.properties.NAME + "</b>");
                    }  
                        
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                })
                .attr("background", "#1C6BA0");

                for (var i = 0; i < deaths.length; i++) {
                  var color;
                  if (deaths[i].minLoss == null) {
                    color = 'grey';
                  } else {
                    color = negativeScale[Math.round((deaths[i].minLoss/3000000)*100)];
                  }
                  svg.selectAll("." + deaths[i].country.replace(" ", "")).attr("style", "fill:" + color);
                }

                var svgNode = svg.node();
                var lastEventListener = function(){
                  var panZoomMap = svgPanZoom(svgNode, {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: false
                  });
                  panZoomMap.setOnZoom(function(level){
                    zoom(level, deathSvgs);
                  });

                  panZoomMap.setOnPan(function(point){
                    pan(point, deathSvgs)
                  })

                  deathSvgs.push(panZoomMap);


                  zoom(3, deathSvgs);
                  pan({x:-1300, y: 300}, deathSvgs);
                };
                //svgNode.addEventListener('load', lastEventListener);
                lastEventListener();
            });

          }

          function pan(point, svgList){
              for (var i = 0; i < svgList.length; i++){
                svgList[i].pan(point);
              }
          }

          function zoom(level, svgList){
              for (var i = 0; i < svgList.length; i++){
                svgList[i].zoom(level);
              }
          }

          function zoomAtPointBy(zoom, x, y, svgList){
              for (var i = 0; i < svgList.length; i++){
                svgList[i].zoomAtPointBy(zoom, {x: this.x, y: this.y});
              }
          }

          jQuery('.nav-tabs a').click(function(){
              $(this).tab('show');
          })
        </script>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
