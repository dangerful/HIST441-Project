<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Hist441-project by dangerful</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <link rel="stylesheet" href="stylesheets/countries.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <script src="javascripts/svg-pan-zoom.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">
      <section>
        <ul class="nav nav-tabs">
          <li class="active"><a data-toggle="tab" href="#JewDeaths">Jew Deaths</a></li>
          <li><a data-toggle="tab" href="#RomaDeaths">Roma Deaths</a></li>
        </ul>
        <div class="tab-content">
          <div id="JewDeaths" class="tab-pane fade in active">
          </div>
          <div id="RomaDeaths" class="tab-pane fade">
          </div>
        </div>
        <script type="text/javascript">
          var svgs = [];
          var countries;
          d3.json("cntry1938.json", function(error, world) {
            if (error) return console.error(error);
            console.log(world);
            countries = topojson.feature(world, world.objects.cntry1938);

            RenderDeaths("Jew");
            RenderDeaths("Roma");
          });

          function RenderDeaths(type){
            d3.json(type+"Deaths.json", function(error, deaths) {
              if (error) return console.error(error);


              <!--https://bost.ocks.org/mike/map/ -->
              var id = type + "DeathMap";
              var section = d3.select("#" + type + "Deaths"); 
              var width = 960,
                height = 920;

              var svg = section.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("id", id);

              var projection = d3.geo.mercator();
              var path = d3.geo.path().projection(projection);
              svg.append("path")
                .datum(countries)
                .attr("d", path);

              var tooltip = d3.select('body').append('div')
              .attr('class', 'hidden tooltip');

              svg.selectAll(".countries").data(countries.features).enter().append("path")
                .attr("class", function(d) { return "country " + d.properties.NAME;})
                .attr("d", path)
                .on('mousemove', function(d) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });
                    var clientRectangle = svg.node().getBoundingClientRect();
                    var overlay = tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15 + clientRectangle.left) +
                                'px; top:' + (mouse[1] + 15 + clientRectangle.top) + 'px');
                    var found = false;
                    for (var i = 0; i < deaths.length; i++){
                      if (deaths[i].country === d.properties.NAME){
                        if (deaths[i].minLoss === deaths[i].maxLoss || deaths[i].maxLoss == null){
                          overlay.html("<b>" + d.properties.NAME + "</b><br/>" + type + " Deaths: ~" + deaths[i].minLoss);// + "<br/>% of Population: " + deaths[i].percent);
                        } else {
                          overlay.html("<b>" + d.properties.NAME + "</b><br/>" + type + " Deaths: " + deaths[i].minLoss + " - " + deaths[i].maxLoss);// + "<br/>% of Population: " + deaths[i].percent);
                        }
                        found = true;
                        break;
                      }                    
                    } 
                    if (found === false) {
                      overlay.html(d.properties.NAME);
                    }  
                        
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                })
                .attr("background", "#1C6BA0");

                for (var i = 0; i < deaths.length; i++) {
                    svg.selectAll("." + deaths[i].country).attr("style", "fill:" + ColorLuminance("#905030", deaths[i].minLoss/1000000 - .5));
                }

                var svgNode = svg.node();
                var lastEventListener = function(){
                  var panZoomMap = svgPanZoom(svgNode, {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: false
                  });
                  panZoomMap.setOnZoom(function(level){
                    zoom(level);
                  });

                  panZoomMap.setOnPan(function(point){
                    pan(point)
                  })

                  svgs.push(panZoomMap);


                  zoom(3);
                  pan({x:-1300, y: 300});
                };
                //svgNode.addEventListener('load', lastEventListener);
                lastEventListener();
            });

          }

          function pan(point){
              for (var i = 0; i < svgs.length; i++){
                svgs[i].pan(point);
              }
          }

          function zoom(level){
              for (var i = 0; i < svgs.length; i++){
                svgs[i].zoom(level);
              }
          }

          function zoomAtPointBy(zoom, x, y){
              for (var i = 0; i < svgs.length; i++){
                svgs[i].zoomAtPointBy(zoom, {x: this.x, y: this.y});
              }
          }

          //https://www.sitepoint.com/javascript-generate-lighter-darker-color/
          function ColorLuminance(hex, lum) {
            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
              hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;

            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
              c = parseInt(hex.substr(i*2,2), 16);
              c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
              rgb += ("00"+c).substr(c.length);
            }

            return rgb;
          }

          jQuery('.nav-tabs a').click(function(){
              $(this).tab('show');
          })
        </script>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
